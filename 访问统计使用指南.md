# 网站访问统计使用指南

## 📊 项目说明

本项目为您的签证地图网站（https://figsama.github.io/2026qzdt/）添加了访问统计功能，可以：
- 📍 追踪访客的地理位置（城市级别）
- 🗺️ 在地图上可视化展示访客分布
- 📈 统计访问量、访问城市数、访问国家数等
- 🏆 显示访问城市排行榜

## 🗂️ 新增文件说明

### 1. `visitor-tracker.js` - 访客追踪脚本
这个脚本会在您的主页面中运行，自动记录访客信息：
- 获取访客的 IP 地址和地理位置（城市、国家）
- 记录访客的浏览器、操作系统等设备信息
- 将数据保存到 Firebase Firestore 数据库
- 使用 24 小时去重机制，避免重复统计

### 2. `访问统计地图.html` - 统计展示页面
这是一个独立的页面，用于展示所有访问数据：
- 显示总访问量、访问城市数、访问国家数、今日访问
- 在中国地图上显示访客城市分布热力图
- 显示访问城市排行榜（前 20 名）
- 每 30 秒自动刷新数据

### 3. `FIREBASE_SETUP.md` - Firebase 配置指南
详细的 Firebase 配置步骤说明。

## 🚀 快速开始

### 第一步：配置 Firebase

请按照 `FIREBASE_SETUP.md` 中的说明完成 Firebase 配置。简要步骤：

1. 创建 Firebase 项目
2. 启用 Firestore Database
3. 获取 Firebase 配置信息
4. 配置安全规则

### 第二步：修改配置文件

#### 2.1 修改 `visitor-tracker.js`

找到第 11-17 行，替换为您的 Firebase 配置：

```javascript
const firebaseConfig = {
  apiKey: "您的API密钥",
  authDomain: "您的项目ID.firebaseapp.com",
  projectId: "您的项目ID",
  storageBucket: "您的项目ID.appspot.com",
  messagingSenderId: "您的消息发送者ID",
  appId: "您的应用ID"
};
```

#### 2.2 修改 `访问统计地图.html`

找到第 187-193 行，同样替换为您的 Firebase 配置。

### 第三步：在主页面中添加追踪代码

在您的 `index.html` 文件的 `</head>` 标签之前添加：

```html
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- 访客追踪脚本 -->
<script src="visitor-tracker.js"></script>
```

### 第四步：部署到 GitHub Pages

1. 提交所有文件到 GitHub 仓库：
```bash
git add .
git commit -m "添加访问统计功能"
git push
```

2. 等待 GitHub Pages 自动部署（1-2 分钟）

### 第五步：测试

1. 访问主页：https://figsama.github.io/2026qzdt/
2. 访问统计页面：https://figsama.github.io/2026qzdt/访问统计地图.html
3. 在 Firebase Console 中检查是否有数据记录

## 📋 功能详解

### IP 定位服务

脚本使用了三个免费的 IP 定位 API，按优先级自动切换：

1. **ipapi.co** - 每天 1000 次免费请求
2. **ip-api.com** - 免费无限制（有速率限制）
3. **ipwhois.app** - 每月 10000 次免费请求

### 记录的数据字段

每次访问记录包含以下信息：

**位置信息：**
- `ip` - IP 地址
- `city` - 城市
- `region` - 省份/地区
- `country` - 国家
- `countryCode` - 国家代码
- `latitude` - 纬度
- `longitude` - 经度
- `timezone` - 时区
- `isp` - 网络运营商

**设备信息：**
- `browser` - 浏览器
- `os` - 操作系统
- `language` - 语言
- `screenResolution` - 屏幕分辨率
- `viewport` - 视口大小

**访问信息：**
- `url` - 访问的 URL
- `referrer` - 来源网站
- `timestamp` - 访问时间

### 去重机制

为了避免重复统计，脚本使用 `localStorage` 记录上次访问时间：
- 同一用户 24 小时内只记录一次
- 如果用户清除浏览器缓存，会被重新记录
- 不同浏览器或设备会分别记录

## 🎨 自定义配置

### 修改去重时间

在 `visitor-tracker.js` 中，找到第 157 行：

```javascript
if (lastVisit && (now - parseInt(lastVisit)) < 24 * 60 * 60 * 1000) {
```

修改 `24` 为其他小时数，例如改为 `12` 表示 12 小时。

### 修改地图样式

在 `访问统计地图.html` 中，找到 `renderMap` 函数（第 267 行），可以修改：

- 地图颜色：修改 `itemStyle.areaColor` 
- 散点大小：修改 `symbolSize` 函数
- 散点颜色：修改 `itemStyle.color`

### 添加更多城市坐标

在 `访问统计地图.html` 中，找到 `cityCoordinates` 对象（第 215 行），添加更多城市：

```javascript
'新城市': [经度, 纬度],
```

## 🔍 查看数据

### 在网站上查看

访问：https://figsama.github.io/2026qzdt/访问统计地图.html

### 在 Firebase Console 查看

1. 访问 [Firebase Console](https://console.firebase.google.com/)
2. 选择您的项目
3. 点击 "Firestore Database"
4. 查看 `visits` 集合

### 导出数据

在 Firebase Console 中，可以：
1. 点击任意文档查看详情
2. 使用 Firebase CLI 导出整个集合
3. 使用 Cloud Functions 定期导出到 CSV

## 📊 数据分析示例

### 查询特定日期的访问

```javascript
const today = new Date();
today.setHours(0, 0, 0, 0);

db.collection('visits')
  .where('timestamp', '>=', today)
  .get()
  .then(snapshot => {
    console.log('今日访问量:', snapshot.size);
  });
```

### 统计访问最多的城市

```javascript
db.collection('visits')
  .get()
  .then(snapshot => {
    const cities = {};
    snapshot.forEach(doc => {
      const city = doc.data().city;
      cities[city] = (cities[city] || 0) + 1;
    });
    console.log('城市统计:', cities);
  });
```

## ⚠️ 注意事项

### 隐私保护

- IP 地址会被记录，但仅用于地理位置统计
- 不会记录任何个人身份信息
- 建议在网站上添加隐私政策说明

### 费用控制

Firebase 免费额度：
- 读取：50,000 次/天
- 写入：20,000 次/天
- 存储：1 GB

建议设置使用量警报：
1. 在 Firebase Console 中点击 "Usage and billing"
2. 设置每日/每月预算警报

### 安全规则

当前配置允许任何人读写 `visits` 集合，这对于访问统计是合适的。

如果需要更严格的控制，可以修改安全规则：

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /visits/{visit} {
      // 只允许创建和读取，不允许更新和删除
      allow read, create: if true;
      allow update, delete: if false;
    }
  }
}
```

## 🐛 故障排查

### 问题 1：数据没有保存

**检查清单：**
- [ ] Firebase 配置是否正确
- [ ] Firestore 是否已启用
- [ ] 安全规则是否允许写入
- [ ] 浏览器控制台是否有错误

**解决方法：**
打开浏览器控制台（F12），查看错误信息。

### 问题 2：地图不显示

**可能原因：**
- 中国地图 JSON 文件加载失败
- ECharts 库未加载
- 数据格式不正确

**解决方法：**
检查浏览器控制台的错误信息，确保所有外部资源加载成功。

### 问题 3：城市显示为"未知"

**原因：**
- IP 定位 API 失败
- 访客使用了 VPN 或代理
- IP 数据库中没有该 IP 的信息

**说明：**
这是正常现象，免费的 IP 定位服务准确度有限。

### 问题 4：访问量异常增长

**可能原因：**
- 网站被爬虫访问
- 有人恶意刷访问量

**解决方法：**
1. 添加人机验证（如 reCAPTCHA）
2. 启用 Firebase App Check
3. 在 Firestore 规则中添加速率限制

## 🚀 进阶功能

### 1. 添加实时通知

当有新访客时发送通知：

```javascript
// 在 visitor-tracker.js 中添加
await db.collection('visits').add(visitData);
// 可以调用 webhook 或发送邮件
```

### 2. 集成更多数据源

- Google Analytics：专业的分析工具
- Cloudflare Analytics：CDN 级别的统计
- 百度统计：适合国内用户

### 3. 添加更多可视化

- 时间趋势图
- 浏览器/操作系统分布饼图
- 访问来源分析

### 4. 数据导出功能

添加一个导出按钮，将数据导出为 CSV：

```javascript
function exportToCSV() {
  db.collection('visits').get().then(snapshot => {
    const data = snapshot.docs.map(doc => doc.data());
    // 转换为 CSV 并下载
  });
}
```

## 📚 相关资源

- [Firebase 文档](https://firebase.google.com/docs)
- [ECharts 文档](https://echarts.apache.org/zh/index.html)
- [IP 定位 API 文档](https://ipapi.co/docs/)
- [GitHub Pages 文档](https://docs.github.com/en/pages)

## 🆘 获取帮助

如果遇到问题，可以：
1. 查看浏览器控制台的错误信息
2. 检查 Firebase Console 的日志
3. 查看本项目的 GitHub Issues
4. 参考 Firebase 社区和文档

---

祝您使用愉快！如有问题欢迎反馈。 🎉
