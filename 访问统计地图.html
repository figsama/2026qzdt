<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ç½‘ç«™è®¿é—®ç»Ÿè®¡åœ°å›¾</title>
  
  <!-- å¼•å…¥ç°ä»£å­—ä½“ -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  
  <!-- å¼•å…¥ ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <style>
    :root {
      --bg-main: #f1f5f9;
      --card-bg: #ffffff;
      --primary-color: #3b82f6;
      --text-color: #1e293b;
      --border-color: #e2e8f0;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Noto Sans SC', sans-serif;
      background-color: var(--bg-main);
      margin: 0;
      padding: 20px;
      color: var(--text-color);
    }

    .container {
      max-width: 1800px;
      margin: 0 auto;
    }

    .header {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      text-align: center;
    }

    h1 {
      margin: 0 0 10px 0;
      font-size: 2em;
      color: var(--text-color);
    }

    .subtitle {
      color: #64748b;
      font-size: 1em;
      margin: 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .stat-value {
      font-size: 2em;
      font-weight: 700;
      color: var(--primary-color);
      margin: 10px 0;
    }

    .stat-label {
      color: #64748b;
      font-size: 0.9em;
    }

    .map-container {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    #visitMap {
      width: 100%;
      height: 600px;
    }

    .city-list {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .city-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.2s;
    }

    .city-item:hover {
      background-color: #f8fafc;
    }

    .city-item:last-child {
      border-bottom: none;
    }

    .city-name {
      font-weight: 600;
      color: var(--text-color);
    }

    .city-count {
      background: var(--primary-color);
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: 600;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #64748b;
    }

    .error {
      background: #fee2e2;
      color: #991b1b;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }

    .info-box {
      background: #dbeafe;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      border-left: 4px solid var(--primary-color);
    }

    .config-section {
      background: #fff7ed;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      border-left: 4px solid #f59e0b;
    }

    .code-block {
      background: #1e293b;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      transition: all 0.2s;
    }

    button:hover {
      background: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
    }

    button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ—ºï¸ ç½‘ç«™è®¿é—®ç»Ÿè®¡åœ°å›¾</h1>
      <p class="subtitle">å®æ—¶è¿½è¸ªæ‚¨çš„ç½‘ç«™è®¿å®¢æ¥æºåˆ†å¸ƒ</p>
    </div>

    <div id="configNotice" class="config-section">
      <h3>âš™ï¸ é…ç½®è¯´æ˜</h3>
      <p><strong>é‡è¦ï¼š</strong>æ‚¨éœ€è¦å…ˆé…ç½® Firebase æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</p>
      <ol>
        <li>è®¿é—® <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a></li>
        <li>åˆ›å»ºæ–°é¡¹ç›®æˆ–é€‰æ‹©ç°æœ‰é¡¹ç›®</li>
        <li>å¯ç”¨ Firestore Database</li>
        <li>åœ¨é¡¹ç›®è®¾ç½®ä¸­è·å–æ‚¨çš„é…ç½®ä¿¡æ¯</li>
        <li>å°†é…ç½®ä¿¡æ¯å¡«å…¥ä¸‹æ–¹ä»£ç ä¸­çš„ firebaseConfig å¯¹è±¡</li>
      </ol>
      <p>è¯¦ç»†é…ç½®æŒ‡å—è¯·æŸ¥çœ‹é¡¹ç›®ä¸­çš„ <code>FIREBASE_SETUP.md</code> æ–‡ä»¶ã€‚</p>
      <button onclick="document.getElementById('configNotice').style.display='none'">æˆ‘çŸ¥é“äº†</button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">æ€»è®¿é—®é‡</div>
        <div class="stat-value" id="totalVisits">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">è®¿é—®åŸå¸‚æ•°</div>
        <div class="stat-value" id="totalCities">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">è®¿é—®å›½å®¶æ•°</div>
        <div class="stat-value" id="totalCountries">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ä»Šæ—¥è®¿é—®</div>
        <div class="stat-value" id="todayVisits">-</div>
      </div>
    </div>

    <div class="map-container">
      <h2>è®¿å®¢åœ°ç†åˆ†å¸ƒå›¾</h2>
      <div id="visitMap"></div>
    </div>

    <div class="city-list">
      <h2>è®¿é—®åŸå¸‚æ’è¡Œ</h2>
      <div id="cityRanking">
        <div class="loading">åŠ è½½ä¸­...</div>
      </div>
    </div>
  </div>

  <script>
    // Firebase é…ç½® - å·²é…ç½®ä¸º visamap-884ae é¡¹ç›®
    const firebaseConfig = {
      apiKey: "AIzaSyDIyz1W_TnhtNgaNQkPNv131plJPoL4pwE",
      authDomain: "visamap-884ae.firebaseapp.com",
      projectId: "visamap-884ae",
      storageBucket: "visamap-884ae.firebasestorage.app",
      messagingSenderId: "755802981286",
      appId: "1:755802981286:web:f3c2a89009f4bf1d5dc567"
    };

    // Firebase å·²é…ç½®
    const isConfigured = true;

    let db;
    if (isConfigured) {
      // åˆå§‹åŒ– Firebase
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
    }

    // ä¸­å›½ä¸»è¦åŸå¸‚åæ ‡æ˜ å°„
    const cityCoordinates = {
      'åŒ—äº¬': [116.4074, 39.9042],
      'ä¸Šæµ·': [121.4737, 31.2304],
      'å¹¿å·': [113.2644, 23.1291],
      'æ·±åœ³': [114.0579, 22.5431],
      'æ­å·': [120.1551, 30.2741],
      'æˆéƒ½': [104.0668, 30.5728],
      'é‡åº†': [106.5516, 29.5630],
      'æ­¦æ±‰': [114.3055, 30.5931],
      'è¥¿å®‰': [108.9398, 34.3416],
      'å¤©æ´¥': [117.2010, 39.0842],
      'å—äº¬': [118.7969, 32.0603],
      'è‹å·': [120.5954, 31.2989],
      'éƒ‘å·': [113.6254, 34.7466],
      'é•¿æ²™': [112.9388, 28.2282],
      'æ²ˆé˜³': [123.4328, 41.8045],
      'é’å²›': [120.3826, 36.0671],
      'åˆè‚¥': [117.2272, 31.8206],
      'æµå—': [117.1205, 36.6519],
      'å¦é—¨': [118.0894, 24.4798],
      'ç¦å·': [119.2965, 26.0745],
      'å—æ˜Œ': [115.8581, 28.6832],
      'æ˜†æ˜': [102.8329, 24.8801],
      'è´µé˜³': [106.6302, 26.6477],
      'å…°å·': [103.8343, 36.0611],
      'å¤ªåŸ': [112.5489, 37.8706],
      'çŸ³å®¶åº„': [114.5149, 38.0428],
      'å“ˆå°”æ»¨': [126.5349, 45.8038],
      'é•¿æ˜¥': [125.3245, 43.8171],
      'ä¹Œé²æœ¨é½': [87.6278, 43.7928],
      'å‘¼å’Œæµ©ç‰¹': [111.6708, 40.8183],
      'æµ·å£': [110.3312, 20.0311],
      'å—å®': [108.3661, 22.8172],
      'æ‹‰è¨': [91.1175, 29.6497],
      'é“¶å·': [106.2309, 38.4872],
      'è¥¿å®': [101.7782, 36.6171]
    };

    // åˆå§‹åŒ–åœ°å›¾
    const chart = echarts.init(document.getElementById('visitMap'));

    // åŠ è½½è®¿é—®æ•°æ®
    async function loadVisitData() {
      if (!isConfigured) {
        showConfigError();
        return;
      }

      try {
        const visitsRef = db.collection('visits');
        const snapshot = await visitsRef.get();
        
        const cityStats = {};
        const countryStats = {};
        let totalVisits = 0;
        let todayVisits = 0;
        
        const today = new Date().toDateString();
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const city = data.city || 'æœªçŸ¥';
          const country = data.country || 'æœªçŸ¥';
          const visitDate = data.timestamp ? data.timestamp.toDate().toDateString() : '';
          
          // ç»Ÿè®¡åŸå¸‚
          cityStats[city] = (cityStats[city] || 0) + 1;
          
          // ç»Ÿè®¡å›½å®¶
          countryStats[country] = (countryStats[country] || 0) + 1;
          
          totalVisits++;
          
          if (visitDate === today) {
            todayVisits++;
          }
        });
        
        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
        document.getElementById('totalVisits').textContent = totalVisits;
        document.getElementById('totalCities').textContent = Object.keys(cityStats).length;
        document.getElementById('totalCountries').textContent = Object.keys(countryStats).length;
        document.getElementById('todayVisits').textContent = todayVisits;
        
        // å‡†å¤‡åœ°å›¾æ•°æ®
        const mapData = Object.entries(cityStats).map(([city, count]) => {
          const coords = cityCoordinates[city] || [0, 0];
          return {
            name: city,
            value: [...coords, count]
          };
        }).filter(item => item.value[0] !== 0 && item.value[1] !== 0);
        
        // æ¸²æŸ“åœ°å›¾
        renderMap(mapData);
        
        // æ¸²æŸ“åŸå¸‚æ’è¡Œ
        renderCityRanking(cityStats);
        
      } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        document.getElementById('cityRanking').innerHTML = 
          '<div class="error">åŠ è½½æ•°æ®å¤±è´¥: ' + error.message + '</div>';
      }
    }

    function renderMap(data) {
      const option = {
        backgroundColor: '#f1f5f9',
        title: {
          text: 'è®¿å®¢åŸå¸‚åˆ†å¸ƒçƒ­åŠ›å›¾',
          left: 'center',
          top: 20,
          textStyle: {
            color: '#1e293b',
            fontSize: 20,
            fontWeight: 600
          }
        },
        tooltip: {
          trigger: 'item',
          formatter: function(params) {
            if (params.value) {
              return params.name + '<br/>è®¿é—®æ¬¡æ•°: ' + params.value[2];
            }
            return params.name;
          }
        },
        geo: {
          map: 'china',
          roam: true,
          label: {
            emphasis: {
              show: true
            }
          },
          itemStyle: {
            normal: {
              areaColor: '#e2e8f0',
              borderColor: '#94a3b8'
            },
            emphasis: {
              areaColor: '#cbd5e1'
            }
          }
        },
        series: [
          {
            name: 'è®¿é—®é‡',
            type: 'scatter',
            coordinateSystem: 'geo',
            data: data,
            symbolSize: function (val) {
              return Math.max(10, Math.min(50, val[2] * 3));
            },
            label: {
              formatter: '{b}',
              position: 'right',
              show: false
            },
            itemStyle: {
              color: '#3b82f6',
              shadowBlur: 10,
              shadowColor: 'rgba(59, 130, 246, 0.5)'
            },
            emphasis: {
              label: {
                show: true
              }
            }
          },
          {
            name: 'çƒ­åŠ›å›¾',
            type: 'heatmap',
            coordinateSystem: 'geo',
            data: data,
            pointSize: 5,
            blurSize: 6
          }
        ]
      };

      // åŠ è½½ä¸­å›½åœ°å›¾
      fetch('https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json')
        .then(response => response.json())
        .then(chinaJson => {
          echarts.registerMap('china', chinaJson);
          chart.setOption(option);
        })
        .catch(error => {
          console.error('åŠ è½½åœ°å›¾æ•°æ®å¤±è´¥:', error);
        });
    }

    function renderCityRanking(cityStats) {
      const sortedCities = Object.entries(cityStats)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 20); // åªæ˜¾ç¤ºå‰20å
      
      const html = sortedCities.map(([city, count], index) => `
        <div class="city-item">
          <div>
            <span style="color: #64748b; margin-right: 10px;">#${index + 1}</span>
            <span class="city-name">${city}</span>
          </div>
          <div class="city-count">${count}</div>
        </div>
      `).join('');
      
      document.getElementById('cityRanking').innerHTML = html || '<div class="loading">æš‚æ— æ•°æ®</div>';
    }

    function showConfigError() {
      const errorHtml = `
        <div class="error">
          <h3>âš ï¸ æœªé…ç½® Firebase</h3>
          <p>è¯·å…ˆæŒ‰ç…§ä¸Šæ–¹è¯´æ˜é…ç½® Firebaseï¼Œç„¶ååˆ·æ–°é¡µé¢ã€‚</p>
        </div>
      `;
      document.getElementById('cityRanking').innerHTML = errorHtml;
      document.getElementById('totalVisits').textContent = '0';
      document.getElementById('totalCities').textContent = '0';
      document.getElementById('totalCountries').textContent = '0';
      document.getElementById('todayVisits').textContent = '0';
    }

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    window.addEventListener('load', loadVisitData);

    // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡æ•°æ®
    if (isConfigured) {
      setInterval(loadVisitData, 30000);
    }
  </script>
</body>
</html>
